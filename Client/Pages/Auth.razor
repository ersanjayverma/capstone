@page "/"
@inject HttpClient Http
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Authorization

<AuthorizeView>
    <Authorized Context="auth">
        <div>
            <h3>Welcome, @auth.User.Identity?.Name!</h3>

            @if (userInfo == null)
            {
                <p>Loading user info...</p>
            }
            else
            {
                <h5>User Info</h5>
                <ul>
                    <li><strong>Name:</strong> @userInfo.Name</li>
                    <li><strong>Email:</strong> @userInfo.Email</li>
                    <li><strong>Subject (sub):</strong> @userInfo.Subject</li>
                    <li><strong>Provider:</strong> @userInfo.Provider</li>
                    <li>
                        <strong>Roles:</strong>
                        @if (userInfo.Roles?.Count > 0)
                        {
                            <ul>
                                @foreach (var role in userInfo.Roles)
                                {
                                    <li>@role</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <em>None</em>
                        }
                    </li>
                </ul>
            }
        </div>
    </Authorized>

    <NotAuthorized>
        <p>You are not logged in. Please log in.</p>
    </NotAuthorized>
</AuthorizeView>

@code {
    private UserInfo? userInfo;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            userInfo = await Http.GetFromJsonAsync<UserInfo>("api/user/me");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to load user info: {ex.Message}");
        }
    }

    public class UserInfo
    {
        public string? Name { get; set; }
        public string? Email { get; set; }
        public string? Subject { get; set; }
        public string? Provider { get; set; }
        public List<string>? Roles { get; set; }
    }
}
